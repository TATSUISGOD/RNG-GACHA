<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RNG Gacha Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  font-family:sans-serif;
  color:#fff;
  text-align:center;
  background:linear-gradient(180deg,#1a1a2e,#16213e);
  transition:background 1s;
}
button{
  padding:10px 20px;
  font-size:16px;
  margin:5px;
}
.hidden{display:none}
#rollText{
  font-size:32px;
  margin-top:40px;
}
#result{
  font-size:40px;
  margin-top:20px;
}
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:10;
}
.card{
  padding:12px;
  margin:8px;
  border-radius:8px;
  background:rgba(0,0,0,.4);
}
.Common{color:#bbb}
.Rare{color:#4af}
.Epic{color:#c6f}
.Legend{color:gold}
.Mythic{
  background:linear-gradient(45deg,red,orange,yellow,green,cyan,blue,purple);
  -webkit-background-clip:text;
  color:transparent;
  font-weight:bold;
}
</style>
</head>
<body>

<h1>ğŸŒŒ RNG Gacha ğŸŒŒ</h1>

<p>ğŸ² ã‚¬ãƒãƒ£å›æ•°: <span id="count">0</span> / å¤©äº•: 100</p>

<button onclick="rollGacha()">ğŸ° ã‚¬ãƒãƒ£</button>
<button onclick="showDex()">ğŸ“– å›³é‘‘</button>

<div id="rollText"></div>
<div id="result"></div>

<div id="overlay" class="hidden"></div>

<script>
/* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
const rarityOrder=["Common","Rare","Epic","Legend","Mythic"];

const pool=[
  {name:"Dust Aura",rarity:"Common",bg:"#2b2b2b"},
  {name:"Stone Aura",rarity:"Common",bg:"#3a3a3a"},
  {name:"Blue Spark",rarity:"Rare",bg:"#0a2a4a"},
  {name:"Crimson Flame",rarity:"Rare",bg:"#4a0a0a"},
  {name:"Void Pulse",rarity:"Epic",bg:"#2a003a"},
  {name:"Heaven Light",rarity:"Epic",bg:"#223355"},
  {name:"Solar Crown",rarity:"Legend",bg:"#5a4a00"},
  {name:"Dragon Halo",rarity:"Legend",bg:"#5a2a1a"},
  {name:"Abyss King",rarity:"Mythic",bg:"#120018"},
  {name:"Celestial God",rarity:"Mythic",bg:"#001833"}
];

const rates=[
  {r:"Mythic",p:1},
  {r:"Legend",p:4},
  {r:"Epic",p:15},
  {r:"Rare",p:30},
  {r:"Common",p:50}
];

let rolls=+localStorage.getItem("rolls")||0;
let pity=+localStorage.getItem("pity")||0;
let dex=JSON.parse(localStorage.getItem("dex")||"{}");
let currentBg=JSON.parse(localStorage.getItem("bg")||"null");

const countEl=document.getElementById("count");
countEl.textContent=rolls;

if(currentBg){
  document.body.style.background=currentBg.bg;
}

/* ===== ã‚¬ãƒãƒ£ ===== */
function rollGacha(){
  document.getElementById("result").textContent="";
  rolls++; pity++;
  localStorage.setItem("rolls",rolls);
  countEl.textContent=rolls;

  let rarity;
  if(pity>=100){
    rarity="Legend";
    pity=0;
  }else{
    let r=Math.random()*100,s=0;
    for(const g of rates){
      s+=g.p;
      if(r<s){rarity=g.r;break;}
    }
  }
  localStorage.setItem("pity",pity);

  const list=pool.filter(x=>x.rarity===rarity);
  const item=list[Math.floor(Math.random()*list.length)];
  animateRoll(item);
}

/* ===== æ¼”å‡º ===== */
function animateRoll(item){
  const rollText=document.getElementById("rollText");
  rollText.textContent="";
  let steps=["???","???",item.rarity,item.name];
  let i=0;
  let int=setInterval(()=>{
    rollText.textContent=steps[i];
    i++;
    if(i>=steps.length){
      clearInterval(int);
      showResult(item);
    }
  },400);
}

/* ===== çµæœ ===== */
function showResult(item){
  document.getElementById("rollText").textContent="";
  document.getElementById("result").innerHTML=
    `<span class="${item.rarity}">${item.name}</span>`;

  dex[item.name]=item;
  localStorage.setItem("dex",JSON.stringify(dex));

  handleBg(item);
}

/* ===== èƒŒæ™¯å‡¦ç† ===== */
function handleBg(item){
  if(!currentBg || rank(item.rarity)>rank(currentBg.rarity)){
    applyBg(item);
    return;
  }
  if(rank(item.rarity)>=rank("Legend")){
    askBg(item);
  }
}

function applyBg(item){
  document.body.style.background=item.bg;
  currentBg=item;
  localStorage.setItem("bg",JSON.stringify(item));
}

function askBg(item){
  const o=document.getElementById("overlay");
  o.classList.remove("hidden");
  o.innerHTML=`
    <h2>èƒŒæ™¯ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ</h2>
    <p class="${item.rarity}">${item.name}</p>
    <button onclick='applyBg(${JSON.stringify(item)});closeOverlay()'>ã¯ã„</button>
    <button onclick='closeOverlay()'>ã„ã„ãˆ</button>
  `;
}

function closeOverlay(){
  document.getElementById("overlay").classList.add("hidden");
  document.getElementById("overlay").innerHTML="";
}

/* ===== å›³é‘‘ ===== */
function showDex(){
  const o=document.getElementById("overlay");
  o.classList.remove("hidden");
  let h="<h2>ğŸ“– å›³é‘‘</h2>";
  for(const k in dex){
    const d=dex[k];
    h+=`<div class="card ${d.rarity}">${d.name} (${d.rarity})</div>`;
  }
  h+="<br><button onclick='closeOverlay()'>é–‰ã˜ã‚‹</button>";
  o.innerHTML=h;
}

function rank(r){return rarityOrder.indexOf(r);}
</script>

</body>
</html>
